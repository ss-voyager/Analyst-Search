<?xml version="1.0" encoding="UTF-8"?>
<!--
  HttpPlatformHandler configuration for running Node.js Express app in IIS.

  Prerequisites:
  1. HttpPlatformHandler module installed in IIS
  2. Node.js installed and in system PATH (or update processPath below)

  Usage (as standalone site):
  1. Run: npm run build:iis-full
  2. Deploy dist/ folder to IIS site
  3. Ensure logs/ directory has write permissions for IIS AppPool identity

  Usage (as virtual application under existing site):
  1. Set VITE_BASE_PATH=/your-app-name/ in client/.env before building
  2. Run: npm run build:iis-full
  3. In IIS Manager, right-click your site > Add Application
  4. Set Alias to your app name (e.g., "analyst-search")
  5. Set Physical path to the dist/ folder
  6. Ensure logs/ directory has write permissions
-->
<configuration>
  <system.webServer>
    <!-- HttpPlatformHandler: Routes all requests to Node.js -->
    <handlers>
      <add name="httpPlatformHandler" path="*" verb="*"
           modules="httpPlatformHandler" resourceType="Unspecified" />
    </handlers>

    <!-- Node.js process configuration -->
    <httpPlatform
      stdoutLogEnabled="true"
      stdoutLogFile=".\logs\node.log"
      startupTimeLimit="60"
      startupRetryCount="3"
      requestTimeout="00:05:00"
      processPath="node"
      arguments=".\index.cjs">
      <environmentVariables>
        <!-- IIS assigns a dynamic port via HTTP_PLATFORM_PORT -->
        <environmentVariable name="PORT" value="%HTTP_PLATFORM_PORT%" />
        <environmentVariable name="NODE_ENV" value="production" />
        <!--
          Add additional environment variables here, or set them in:
          - IIS Application Settings
          - Windows System Environment Variables
          - A .env file in the deployment folder
        -->
      </environmentVariables>
    </httpPlatform>

    <!-- URL Rewrite rules -->
    <rewrite>
      <rules>
        <!-- Optional: Redirect HTTP to HTTPS -->
        <!--
        <rule name="HTTPS Redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
        -->
      </rules>
    </rewrite>

    <!-- Security: Hide sensitive directories -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="node_modules" />
          <add segment="logs" />
          <add segment=".env" />
        </hiddenSegments>
      </requestFiltering>
    </security>

    <!-- Static content caching for assets -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="30.00:00:00" />
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <!-- Compression -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
  </system.webServer>
</configuration>
